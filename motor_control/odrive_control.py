from __future__ import print_function

import argparse
import odrive
import time
import math

from odrive.utils import start_liveplotter
from odrive.enums import *

STRAIGHT_POSITION = 0.55

def liveplot(driver_name):
    start_liveplotter(lambda: [
        driver_name.axis0.encoder.pos_estimate,
        driver_name.axis0.encoder.vel_estimate,
        driver_name.axis0.motor.current_control.Iq_measured
    ])

def clear_errors(driver_name):
    if driver_name.axis0.error:
        print("axis 0", driver_name.axis0.error)
        driver_name.axis0.error = 0

    if driver_name.axis0.motor.error:
        print("motor 0", driver_name.axis0.motor.error)
        driver_name.axis0.motor.error = 0

    if driver_name.axis0.encoder.error:
        print("encoder 0", driver_name.axis0.encoder.error)
        driver_name.axis0.encoder.error = 0

def Calibration(driver_name):
    # Calibrate motor and wait for it to finish
    print("Starting calibration...")
    driver_name.axis0.requested_state = AXIS_STATE_FULL_CALIBRATION_SEQUENCE
    while driver_name.axis0.current_state != AXIS_STATE_IDLE:
        time.sleep(0.1)

def shut_down(driver_name):
    # Stopping the motor spin
    driver_name.axis0.controller.input_vel = 0

    # Moving to straight position
    driver_name.axis0.controller.config.control_mode = CONTROL_MODE_POSITION_CONTROL
    driver_name.axis0.controller.input_pos = STRAIGHT_POSITION
    print("Going back to home position")

def get_motor_state(driver_name):
    motor_pos =  driver_name.axis0.encoder.pos_estimate
    motor_vel =  driver_name.axis0.encoder.vel_estimate
    motor_current = driver_name.axis0.motor.current_control.Iq_setpoint

    return motor_pos, motor_vel, motor_current

def position_control(driver_name):
    driver_name.axis0.controller.config.control_mode = CONTROL_MODE_POSITION_CONTROL

    # A sine wave to test
    t0 = time.monotonic()
    while time.monotonic() - t0 < 10:
        try:
            pos = 4.0 * math.sin(2 * (time.monotonic() - t0))
            driver_name.axis0.controller.input_pos = pos
            clear_errors(driver_name)

            output_pos, output_vel, output_current = get_motor_state(driver_name)
            # print("Moving to {} [turn]".format(output_pos))
            # print("Moving at {} [turn/s]".format(output_vel))
            print("Motor current is {} [A]".format(output_current))
            # print("The position error is {} [turn]".format(pos - output_pos))
            time.sleep(0.01)

        except:
            print("Couldn't complete motion. shutting down")
            shut_down(driver_name)
            raise

def velocity_control(driver_name):
    driver_name.axis0.controller.config.control_mode = CONTROL_MODE_VELOCITY_CONTROL

    # A sine wave to test
    t0 = time.monotonic()
    while time.monotonic() - t0 < 11:
        try:
            vel = 1 * math.sin(4 * (time.monotonic() - t0))
            driver_name.axis0.controller.input_vel = vel
            clear_errors(driver_name)

            output_pos, output_vel, output_current = get_motor_state(driver_name)
            # print("Moving to {} [turn]".format(output_pos))
            # print("Moving at {} [turn/s]".format(output_vel))
            print("Motor current is {} [A]".format(output_current))
            # print("The velocity error is {} [turn/s]".format(vel - output_vel))
            time.sleep(0.01)

        except:
            print("Couldn't complete motion. shutting down")
            shut_down(driver_name)
            raise

def current_control(driver_name):
    driver_name.axis0.controller.config.control_mode = CONTROL_MODE_TORQUE_CONTROL
    
    elbow_torque = [-0.788717144151963, -0.658044422751466, -0.837818238056562, -0.753172877114464, -0.913460033538610, -0.656490555170125, -0.677374672628036, -0.230144643009105, -0.176700280087894, 0.0965791330493117, -0.135183048743904, -0.0296559696373019, -0.397814287632603, -0.400688867934709, -0.424597459122093, -0.239879448663097, -0.393375352386425, -0.477247660831090, -0.837131369569931, -1.45084320171729, -1.91252403637191, -2.21188763229121, -2.28924851472541, -2.56251934293116, -2.69950083262957, -2.07361105297783, -1.06947142275383, -0.759707564009493, -1.21872832513565, -2.09613733682080, -2.35153716150524, -2.35272206683207, -1.66294921553520, -1.14087292861553, -0.426473895799053, -0.493795650994545, -0.277419200604076, -0.458164009732226, -0.349681633556359, -0.638073472827713, -0.417791916099997, -0.590125457484227, -0.352476386284717, -0.280866814193757, -0.0435002432109410, -0.142506686759602, -0.118966571970995, -0.464363040107380, -0.230715237917390, -0.340173041783791, -0.378077141774083, -0.767891485278542, -0.775712959094638, -1.19981860435308, -1.00575192887325, -0.889477689399492, -0.339226726054857, -0.279360212115571, -0.0584271598084042, 0.0130043210803670, 0.324780438450551, 0.384439904246783, 0.732541064458401, 0.852033787766366, 1.12975572541457, 1.09639870341569, 1.07230227180308, 0.767487112509034, 0.587691381708287, 0.439010963609447, 0.382074949591208, 0.310226276874979, -0.110874675387961, -0.804894834057124, -0.564106780894740, 0.511496628584150, 1.06894906358414, 0.791706081389141, 0.0621678182723342, -0.0827462005987517, 0.224570556979511, 0.634377675420161, 0.441713185456929, 0.208691946757954, -0.308368790374488, -0.557464519988906, -0.596126838009245, -0.281689242298714, -0.440837238893957, -0.406056173794176, -0.344426973288128, -0.127310463720579, -0.354939342512350, -0.377785762005643, -0.736694289768709, -0.877922645950875, -1.00424188762413, -0.938518093289886, -1.15530720868841, -1.02023927050425, -1.32652455705905, -1.08557126069948, -0.796697743632294, -0.225878865632225, -0.0728718237915060, 0.222659409913429, -0.0445531569307054, -0.0453541740517089, -0.668474968146028, -0.733218057106234, -0.935735034041589, -0.674380412354573, -0.522269487752907, -0.400929179245300, -0.822230119438106, -0.926095205467688, -1.20910747533760, -1.35527455611654, -1.67665610325596, -2.41869343314239, -2.22699636462826, -0.794467821414979, -0.187658804966039, -0.993394631404324, -1.78153301525556, -2.43573861624313, -2.41438148320637, -2.49541219385823, -2.17982996825613, -2.01339023864856, -1.64227225575360, -1.97778084102087, -1.59445394316167, -1.69584659292474, -1.29330341949739, -1.31473944850940, -0.929340966331544, -0.893655876900680, -0.626774807524430, -0.621465227827833, -0.545080946078972, -0.680253864979576, -0.548866272183539, -0.490948215817446, -0.202103934784037, -0.252222916653967, -0.180322183933235, -0.236209019823847, -0.240517167794077, -0.329600309278446, -0.0394194614140485, 0.0401423093565299, 0.504524051055588, 0.662894590249668, 0.935136991666283, 0.793274698045397, 0.732675659158251, 0.552258149159312, 0.473003928582305, 0.405875510534991, 0.536932716927808, 0.488979209978176, 0.684557181233489, 0.383106439253392, 0.282470782823421, 0.123221451261765, 0.0477017837767050, -0.527480452818785, -0.905911723766914, 0.115263213350043, 1.99825770625637, 2.77829870211842, 1.93515332347904, 0.681666807641787, -0.564946874053580, -1.07548817771826, -1.21748077765850, -0.835462708896120, -0.553678361017142, -0.0423011475971060, 0.206562067270471, 0.229145993845814, -0.493544442229109, -0.639101339166765, -0.520720137977920, -0.102901019263058, -0.00804791297487681, -0.0634544159093115, -0.558136729044686, -0.747689701152261, -1.19802789995124, -1.05071025994053, -1.06014477447307, -0.818548858766515, -0.978997750909033, -0.966318776649539, -0.972676319949324, -0.558411968414573, -0.394116932529995, 0.0207798218167600, -0.00192392085731638, 0.209562105981343, -0.0366116480997649, -0.349187618833563, -0.873829959613235, -1.14028206725952, -1.29765993731684, -1.19260019312737, -1.27673535028827, -1.07671709509795, -1.16230654455692, -1.18175038504634, -1.38292020990218, -1.46457096840032, -1.80790791159316, -2.35646659105913, -2.16449846028868, -1.22821031385299, -0.505127769595123, -0.982441810714139, -1.55294588837074, -2.20040281387269, -2.36606021838209, -2.31864984530294, -1.68302113743920, -1.23589539799726, -0.698741462221494, -0.752536089797586, -0.746024881686584, -1.06439802639021, -1.02587997355952, -1.15516813915584, -0.734816101329799, -0.759513187830754, -0.552189248495115, -0.671370401477859, -0.460601460994585, -0.517137133188580, -0.101956794797758, 0.0752936882644239, 0.101109866114254, -0.101663706209848, -0.140019388815530, -0.527649374893946, -0.619299149765282, -0.619107672473914, -0.374659328242529, -0.299617695255935, -0.118887216915109, -0.212230325567480, -0.0124665139526879, 0.0903965410636368, 0.415974696756398, 0.504570041455700, 0.671797309195901, 0.650716425843388, 0.760560509679840, 0.639077130454424, 0.762931176897227, 0.641494311619094, 0.590171815643668, 0.501447358975313, 0.434239150640688, 0.0997288703421731, -0.527829969791295, -0.390140661165971, 1.13447826472349, 2.26366808613317, 1.95242323833622, 0.682597734990264, -0.414272136376862, -0.779256340050465, -0.788480897236504, -0.571104916996623, -0.735337653854509, -0.842541977153301, -0.934098997056139, -0.628621371320807, -0.587538288581178, -0.474095251782682, -0.407979582408506, -0.201617988849519, -0.169842282516154, 0.0927940339305866, -0.158037968530993, -0.350619311889734, -0.769563322607289, -0.783643821190097, -0.946114939538294, -0.796978911371886, -0.934138138271824, -0.773867435931359, -1.04476492010638, -0.599121877263827, -0.637357824766465, -0.362832808071512, -0.459178739038351, -0.418926798421617, -0.542974914979730, -0.511957574904886, -0.680383669794772, -0.711338870683604, -0.770520369915322, -0.461032457781069, -0.432671256129833, -0.523159568858236, -0.958887684369889, -1.45174035379286, -1.82284050386597, -1.81805838530226, -1.82005329752499, -2.43330686599495, -2.42784472473524, -1.42778311683373, -0.209860419648780, -0.723607152634349, -1.31426761353355, -1.95157492858346, -2.04140461897599, -2.37326215402628, -2.18558277830333, -1.73583664611685, -1.09983161249713, -1.19549847227581, -0.887401658254864, -0.920591602095039, -0.766343917212089, -0.935316125027072, -0.630629545236451, -0.494894561158166, -0.430992371527972, -0.598022843171323, -0.661914806489617, -0.699156454578179, -0.311212022959838, -0.225532551187173, 0.172904965145669, 0.126464594134432, 0.238710697465364, -0.231792923770282, -0.351890419891730, -0.772950959434313, -0.747326558031151, -0.821740543067745, -0.567241143131845, -0.442550852793618, -0.0385840940640649, 0.325378778046061, 0.716573037621205, 0.767513246629289, 0.718845986942624, 0.374986449368430, 0.287627260154439, 0.373766681815044, 0.416756602014068, 0.431645139656683, 0.515565992022561, 0.429228745082234, 0.343975476791442, 0.0137601532584007, -0.513384711979819, -0.498222924063509, 0.689625049253658, 2.07648327191309, 1.99469153286829, 1.02482057123374, -0.0744379816468212, -0.410903730236911, -0.492117572058996, -0.430285507077739, -0.757383479230268, -0.786634228383718, -0.646934247247093, -0.193227699436650, -0.208724492655321, -0.467324281573882, -0.730171199235311, -0.418660526819241, -0.376743860781572, -0.0499584953137405, -0.378063154227208, -0.495338753105531, -0.966218933822538, -1.05655008155758, -1.37108734400712, -1.21872534987572, -1.28221965417380, -1.03903220502020, -0.934809510568097, -0.599317073069583, -0.538527656427481, -0.487120325703714, -0.759402017322499, -0.681288164998398, -0.772486203247395, -0.623350502024963, -0.685075211958098, -0.596277763579044, -0.730309772564421, -0.589253620108674, -0.728372982851396, -0.899707590944735, -1.46300461779808, -1.93301210113424, -2.17895891380393, -2.09632746232054, -2.03657520505457, -2.38422984830824, -2.47045669195836, -1.66494886509482, -0.420017220469764, -0.483809714485851, -1.22553181830594, -1.81774983500607, -1.95944741473533, -2.37686209501700, -1.97571798034907, -1.31892198129003, -0.710338976725732, -0.842013560300128, -0.700704624966034, -0.960177949821944, -0.914379471394876, -1.15018604075341, -0.875697466135764, -0.853933920965151, -0.496752684116005, -0.635822069802857, -0.344437016054717, -0.453229614715526, -0.177339607779911, -0.133182359434004, 0.0996015413422087, 0.0401102738851291, 0.141494349623356, -0.324282390596323, -0.348587019667988, -0.886476666156261, -0.811108513595259, -0.805159086648688, -0.375964246778192, -0.115533717565303, 0.346286427129714, 0.574145140164179, 0.729115339480794, 0.461100016981623, 0.266183055169316, 0.0963071489117959, 0.214608432732365, 0.338735392353177, 0.468459503949802, 0.394828483777344, 0.323219871501757, 0.0969089527627058, -0.197791576933046, -0.809904096887674, -0.750756197110735, 0.819835145526980, 2.25974034815544, 2.27561760241283, 1.35561053980154, 0.427395447351353, -0.171777950370115, -0.237893202864698, -0.397333550347397, -0.568508044382979, -0.997350836532008, -1.07265013789264, -0.945204208856911, -0.680225042715495, -0.834913480016317, -0.680603779561944, -0.657864995349269, -0.203515678276888, -0.185867528328821, -0.0688594128949160, -0.405480674180284, -0.600601954839134, -0.875003239501038, -0.780248633322235, -0.939640413413352, -0.826960526123990, -1.01537004131328, -0.934488228012621, -1.04740876178700, -0.656567227941562, -0.603782061679490, -0.334998225083446, -0.333633236734792, -0.197303067216103, -0.419861611694779, -0.326878334424552, -0.719222526947820, -0.599601808027942, -0.699567204386902, -0.687779897469397, -0.852945271266032, -1.12145201525932, -1.35273164719054, -1.69393824976647, -1.73266720671171, -2.02697008361750, -2.80392525380934, -2.92400475212600, -1.79665604633987, -0.807258240631173, -0.739984810166474, -1.35021560474972, -1.55424009276027, -1.96026929955519, -1.96698070059985, -1.93247684155465, -1.31384769099354, -1.13727077646209, -0.924095838918801, -1.29582123108985, -1.23708147761842, -1.58718616638083, -1.28425043365025, -1.37390655397698, -0.985387194971662, -0.972199310207093, -0.651899568099064, -0.568553660917290, -0.322455009220986, -0.393966754054982, -0.0651398336818532, -0.218482581455188, 0.00564271089394903, -0.249128461972164, -0.321042233945818, -0.492059885735386, -0.525266939490958, -0.651505812792359, -0.615822105523603, -0.585118263227376, -0.168879304612284, -0.0490058720349618, 0.498342650564853, 0.558161852488712, 0.680404021884616, 0.413115567641546, 0.257330183698142, 0.140837334895032, 0.515320282401059, 0.901086822076693, 0.998809409312974, 0.793407744104452, 0.431963004013407, 0.309528581183021, -0.132284195083308, -0.583010653099209, 0.264698391145760, 2.20818001808077, 2.75435468612252, 1.63267417967055, -0.0214200840205846, -1.06539871933935, -1.54511392744366, -1.33149926579078, -1.04261677483379, -0.462046884654438, -0.0582135463504671, 0.302298238727242, -0.157579609180327, -0.737122328567664, -1.05916544951560, -0.539465831611021, -0.253453671039287, 0.119355434562544, -0.0320122266805045, -0.319859908347436, -0.886628369278761, -0.954830204535955, -1.16119974568426, -0.909542712448671, -1.03103854977142, -0.845298998718037, -1.05492212600232, -0.771120878613518, -0.781445585192173, -0.345722933934006, -0.333212131345775, -0.0877995168360707, -0.407564646452971, -0.485015985901022, -0.718913944078209, -0.710994678388350, -1.03470323746424, -0.738148853101819, -0.694771208444812, -0.694460348593130, -0.816786633616903, -1.13195652611265, -1.42241534747954, -1.60311241039170, -1.42595202239723, -1.61535461763587, -2.15660355332214, -1.88751697664453, -0.542783286877018, -0.309434021905068, -1.05683112135141, -2.01465760720127, -2.11211891135436, -2.48401978210986, -2.47473693151173, -2.08551963519052, -1.25398288742923, -1.00597888688550, -0.767501483208979, -0.883429519280745, -0.760702261476773, -1.11534467825341, -1.05455472409056, -1.26687027491750, -0.931256537345982, -1.05902711346564, -0.690479057967013, -0.895602267197030, -0.669747249665283, -0.766558860232022, -0.480653108383265, -0.453198614956795, 0.0347868762682940, -0.126359687896056, -0.120674418374163, -0.602784509566600, -0.625152878774346, -0.982770275455345, -0.708486841203830, -0.572656164544880, -0.162186019848463, 0.0379190162179572, 0.328456446482878, 0.500899715463258, 0.634450211140555, 0.545994744490432, 0.610192157850150, 0.560674832343843, 0.793199579798878, 0.897236808406580, 1.08173030325698, 0.836079495579884, 0.527334477846025, 0.223606110955406, -0.235454154126097, -0.517603851621294, 0.444393910608057, 1.95085574816348, 2.28953785236148, 1.18305685128869, -0.141554132848668, -0.279761280921534, -0.143328566295682, -0.0966037123698605, -0.493980442502170, -0.497536717504231, -0.349577391292157, -0.0791798873369638, -0.716811240889700, -1.11974048742449, -1.23013503649965, -0.697901722202345, -0.552897287217585, -0.294247839019837, -0.601901764464044, -0.727796035891578, -1.13135750200610, -1.14014385551352, -1.31143609004582, -1.12404360798202, -1.16469316144294, -0.809776978558674, -0.988002727247669, -0.713953618374997, -0.573805713209853, -0.250125296441790, -0.176180817872602, 0.116059070805016, -0.122162980109819, -0.0983339303376892, -0.571814570006298, -0.641430537336206, -0.680960569652741, -0.386560641078260, -0.383841027635598, -0.396146544201605, -0.748335941122594, -0.952625121174252, -1.22276657132008, -1.10323521168695, -1.59582008181000, -2.32281135172222, -1.89895086405792, -0.498677527907753, 0.0827211584824297, -0.708445428205780, -1.26695699010865, -1.91448595807775, -2.30550036493333, -2.81254981710166, -2.65217922972627, -2.46523013243303, -2.13263611288663, -2.15280664595376, -1.95527955369364, -2.10597335160041, -1.95383317654110, -2.07503136711479, -1.60054964363650, -1.44784639852022, -1.10997419092913, -1.12198129096167, -0.828020769245430, -0.828159347970137, -0.476338998909525, -0.342629581141735, 0.142620656262821, 0.199219456483000, 0.444818606784675, 0.178757629581754, 0.286345855187841, -0.0231033948320493, 0.0196760830620365, -0.112986838909435, 0.156690301359907, 0.241529098064541, 0.693717004509800, 0.739199322576260, 0.843738735209329, 0.803628989804878, 0.864051647463178, 0.747650984041491, 0.767327121732333, 0.684305943859376, 0.678528092855249, 0.684238643400022, 0.590903096108055, 0.316772605486449, 0.136732926295931, -0.451048760889803, -0.752497243323168, 0.293302177427742, 1.85772864779657, 2.20655046300381, 1.11247880413888, -0.205081743538936, -1.04084975573884, -1.23634664115601, -0.980501816710018, -0.554515822773436, -0.535505412760830, -0.443387070656395, -0.357520330482086, -0.0557394156982673, -0.340178489977062, -0.652199288168316, -0.912802630286115, -0.647548894569887, -0.664876260277430, -0.364921308756344, -0.582442016693571, -0.415374347998004, -0.762000812558308, -0.822486248192218, -1.19829984323340, -1.11449268710959, -1.34074539440402, -1.06728125201857, -1.12299956276038, -0.819094768724181, -0.794109651809474, -0.314535389859546, -0.347648457342886, -0.153261631834560, -0.537798746517662, -0.657209243582450, -0.928900460444809, -0.891826500640186, -0.734641614399690, -0.129319882374309, 0.0352180105696703, -0.0947940323693103, -0.663409743176231, -1.06356166170415, -1.28808237795418, -1.48191906171951, -2.21116288065049, -2.71727010334458, -2.05345454705199, -0.646819879127170, -0.0914045849493819, -0.738121033824133, -1.36798061506980, -1.89037151446541, -2.15831733169011, -2.47875423869877, -2.09396518610465, -1.52391115050847, -0.916075831832334, -0.833610152903332, -0.812382826017816, -1.14938014539612, -1.14534340354329, -1.58723210855022, -1.47034637502887, -1.69262901218649, -1.44031224526037, -1.50404339471106, -0.965811589846183, -0.940483508691584, -0.532180997308537, -0.486344954003504, -0.231120550396012, -0.231414912290324, -0.0410043753863918, -0.282356855835226, -0.309437116907948, -0.662800802005059, -0.492615474974306, -0.532206292799457, -0.113542760574879, 0.0797082646338002, 0.381082703331515, 0.394081887910664, 0.482868298263702, 0.359180000978533, 0.626296494602299, 0.613906332916005, 0.731212362162189, 0.582448504736529, 0.464466858085075, 0.425937571706946, 0.163814599960371, 0.333474349976482, -0.187990828109977, -0.918560477511358, -0.366368076455079, 1.45710342159055, 2.68879531072813, 2.33061147833119, 1.09787693665921, -0.00309821074923981, -0.721727377094863, -0.594688719104234, -0.528732098574680, -0.198111618204214, -0.217402293960075, 0.271314831184545, 0.111364679201886, -0.278212170259427, -0.968595347033191, -0.829530523547886, -0.766465725499904, -0.379080238268640, -0.344036203616565, -0.299265331350608, -0.646221418937241, -0.818068525513645, -1.23518197843973, -1.16820527850804, -1.40730853202399, -1.26240262526292, -1.62226202427154, -1.66054491551727, -1.92300389974308, -1.65388385168473, -1.34794415909294, -0.649069653942069, -0.353313532033802, -0.126088617299350, -0.297228412770112, -0.420714381428353, -0.835142738106983, -0.786683485075968, -0.645325058081171, -0.567258864981758, -0.653690386312370, -0.709667468039185, -0.837877138521919, -0.918605377163541, -1.02199407125028, -1.10520771234972, -2.01683559594503, -1.75780167131373, -0.802420910984113, -0.424241456683398, -0.649648696867354, -1.22399146412399, -1.63016798692402, -1.89136181430559, -1.92284685793912, -2.02995299632553, -1.48493858930441, -1.07567607587482, -0.566622518819900, -0.624041047260790, -0.566413771914487, -0.966741866106193, -1.17126530010551, -1.62165155990318, -1.50083364538022, -1.61600533249562, -1.19654427457566, -1.10815115778582, -0.535579894725391, -0.295277670588429, 0.325517420711106, 0.418670111792244, 0.772139624941277, 0.438692369133354, 0.270619883113304, -0.340791963840482, -0.715345640936014, -1.00293456042251, -0.790535242063255, -0.693091527601201, -0.500950970464766, -0.333129255887739, 0.00110637247978975, -0.0961753983543920, 0.0439191632915484, -0.0453876261289792, 0.283995341845377, 0.519074777893296, 0.655773286764386, 0.569956394504871, 0.472793421522043, 0.270299263193741, -0.00425508942910512, -0.238721769425142, -0.794137861796331, 0.0776257944087043, 2.22614075740136, 3.26923684765388, 2.08092721383704, 0.173116237870605, -1.19606184577882, -1.46263609505008, -0.961000190122234, -0.379778744978321, -0.343019448873494, -0.181533558385631, -0.0361380111930454, 0.312811844507047, -0.331785779050711, -0.465239448074431, -0.582581311374303, -0.306824596658297, -0.348284365927715, -0.358282711372163, -0.946618041279901, -1.35009820533519, -1.68774416119738, -1.65181757851287, -1.77947699767039, -1.40694649836035, -1.48590356341282, -1.10359211885596, -1.11985047386555, -0.621052449970544, -0.440299625069174, 0.222187007246517, 0.287785934612975, 0.307558620339258, -0.100018837252697, -0.268028787971543, -0.669446098093201, -0.745826864869424, -0.900507042828357, -0.446460965330031, -0.307947454014016, -0.120681565842256, -0.414705276653442, -0.775727413730424, -0.989319894527958, -1.11789826457206, -1.73434628039184, -2.40020766673523, -2.62614626177725, -1.32088752986390, -0.264941885701222, -0.361857209435737, -1.04155140430800, -1.67702314871848, -2.23780234531520, -2.75961887273041, -2.54024757393256, -1.77643204589025, -0.968906270252623, -0.685222119543900, -0.496939240963774, -0.658667024822407, -0.730982911850421, -1.02681255751638, -1.00510893439638, -1.01055566523141, -0.701260531623213, -0.773435122300303]
    # elbow_torque = [2.37458493223537, 2.53541101912472, 2.71535162581618, 2.79712712480384, 2.89753012980830, 2.88033858629321, 2.68583182360936, 2.43815069603204, 2.24715930653493, 2.08851568149113, 1.79325891224888, 1.42505522402717, 0.991032435352766, 0.545332315715792, 0.173334316294113, -0.0921692020520510, -0.356910119386626, -0.556229603336114, -0.688975930569938, -0.828206038295802, -0.835397119784771, -0.781750442214531, -0.687441173315559, -0.708922081786844, -0.795921606658805, -1.07442897670189, -1.49510915981511, -2.20626982987132, -2.96034947568970, -3.48177435558243, -3.58499282214374, -3.28070835966980, -2.80585816932437, -2.25792935162583, -1.77749832239307, -1.41077217511196, -1.12867900018221, -1.08253711325750, -1.25301799295598, -1.54378903345873, -1.92268190898073, -2.24654769912022, -2.36051680528867, -2.34040995004839, -2.10944678691686, -1.70335464920963, -1.12477803821310, -0.445718968651639, 0.254523974009796, 0.961267715399454, 1.47241821070387, 1.92500823913052, 2.14231021889541, 2.30519479941741, 2.29716188141883, 2.18409345531697, 2.00170604267668, 1.83884777037637, 1.74221310907935, 1.69803553221544, 1.82354052958535, 1.99054295327268, 2.15441539257439, 2.23922652070092, 2.33824689986800, 2.37553314719150, 2.43116487623577, 2.38953401573107, 2.33674922594060, 2.27846321634097, 2.11467998491661, 1.96778270346646, 1.81103358913916, 1.65489437042977, 1.54398385163993, 1.42466459383764, 1.39739624590167, 1.27591036189222, 1.23288083556482, 1.15896138194169, 1.14700343457193, 1.06650843576467, 1.06896289926102, 0.991928912202756, 0.877665545486183, 0.731466811825421, 0.507826198895476, 0.318038281521116, 0.0586009643994303, -0.122291360236784, -0.376208386354174, -0.418376430243631, -0.456868413003972, -0.395493788206801, -0.167758652059083, 0.130279633982383, 0.474923218929945, 0.807988707282930, 1.19654113391877, 1.47088108570767, 1.76738430941024, 1.95090156999584, 2.06708005124034, 2.01997722774019, 1.87850256425890, 1.63997089338220, 1.43676090659792, 1.23166358260621, 0.997880582550426, 0.788092842472417, 0.750751163132323, 0.719070606455161, 0.867757137822967, 1.15213933452118, 1.55710229542858, 2.04099380103566, 2.55780302025742, 2.97842830918301, 3.45801182577891, 3.81154007574963, 4.23352299807736, 4.39243625332261, 4.33713481039933, 3.87117503894947, 3.06921548857122, 2.22500050219847, 1.35294394102616, 0.565172384847906, -0.121351529445584, -0.789952785910573, -1.22102419271835, -1.52754976465975, -1.55473933274663, -1.50787791122609, -1.43066664899792, -1.43284557668049, -1.42823113730022, -1.47994869915601, -1.43806859788781, -1.50380004881975, -1.58170300977571, -1.74449823202215, -1.87663224170525, -1.95577201306974, -2.04489394832649, -2.13199851516969, -2.18584733869068, -2.21623083854497, -2.14122994181443, -1.87838434777639, -1.52082392002619, -1.21558627875285, -1.04638268106299, -0.805146619215699, -0.524378388661950, -0.320144229369448, -0.171536077031253, -0.217033234070275, -0.383298551653490, -0.735231827070570, -1.11124975360824, -1.45717410052883, -1.78032361166821, -2.06924230002622, -2.03314953166972, -1.72614537543678, -1.05151819036077, -0.0938648337055176, 0.830491212979932, 1.47369440998143, 1.87993463942697, 1.97759185013814, 1.81934778705237, 1.56615298634576, 1.41128029754344, 1.30077120250425, 1.38855354655352, 1.65575864159937, 2.03327535909121, 2.26663431367170, 2.54453468620915, 2.89915978881068, 2.99733303239569, 3.01997135388723, 2.86900824539646, 2.56785106212009, 2.33372988266067, 2.11793561529295, 1.86172102022318, 1.76822203621511, 1.57920925326627, 1.40859057158386, 1.26375001379820, 1.00916740009926, 0.880746426486188, 0.747365006387870, 0.831536472501864, 0.991478048649568, 1.28084357761487, 1.58833318619039, 1.89654879152089, 2.08382393351076, 2.10281774041561, 1.84672327798251, 1.56540934055042, 1.23742042720609, 0.911243157239476, 0.700547879001012, 0.372967276884770, 0.127651417697091, -0.0522426994629726, -0.257707659607243, -0.432159061627324, -0.423478150559904, -0.183534023557145, 0.0865377731563774, 0.379246848531574, 0.600719087537192, 0.851169582296447, 1.11199071516310, 1.31722578323350, 1.54020577573228, 1.77046392385542, 2.07008036197878, 2.33294664450427, 2.43201884028784, 2.34066245863830, 2.04502274722664, 1.81985267544246, 1.52123724588481, 1.41326075003249, 1.32942863463229, 1.35641612299481, 1.52903843098497, 1.73473525350266, 2.04279550690847, 2.40246347412489, 2.69805244690665, 3.12380983974689, 3.34918642541620, 3.29464992574070, 2.84601844676672, 2.04520622956515, 0.973459770929467, -0.0495195638273093, -0.720330126681764, -1.19584690354048, -1.47997711180648, -1.63293124966863, -1.63105520578438, -1.56226062294776, -1.27127363889373, -0.982833394728821, -0.705666284870486, -0.508412003861125, -0.465961096036631, -0.405898065088628, -0.499110274425991, -0.542213594693419, -0.683942838312524, -0.680160442568611, -0.794836304251133, -0.963980664357190, -1.15588801614652, -1.34923300002753, -1.57523919179938, -1.67767344824183, -1.77913668729539, -1.81937384739947, -1.83669106379736, -1.72974115687304, -1.58134417009204, -1.28776935588232, -0.996226788385274, -0.706979011183793, -0.536052258747343, -0.441890221301216, -0.446544447959346, -0.625512344077446, -0.798348234277397, -1.03046380796191, -1.32037977332058, -1.51647651450990, -1.70430398839660, -1.74099368458762, -1.70907235002173, -1.48847526117933, -1.02810840154425, -0.492525300427788, 0.127266497210867, 0.641682189536678, 1.12511884462002, 1.48532854864884, 1.67553469038672, 1.69021575849138, 1.62122577093692, 1.67363325540104, 1.85430577061458, 2.04083159729013, 2.20773981614017, 2.35341961029397, 2.51289109493072, 2.60214642067591, 2.68335862862224, 2.63815337233702, 2.43132503597525, 2.12823739570138, 1.72986756285683, 1.51405728035090, 1.33022545766517, 1.24905037632719, 1.24010102230214, 1.16244566579778, 1.17844603645418, 1.12861331085284, 1.08235758875940, 1.09810515521836, 1.05596466796138, 1.10783744127622, 1.05668126634454, 1.06511528153338, 0.981017320701407, 0.977517659160762, 0.835705107367067, 0.742257180069464, 0.606215345589318, 0.561523880332962, 0.525091833656777, 0.459193376207291, 0.406157662137246, 0.240348476725220, 0.208071256211169, 0.142894981162377, 0.120291548347883, 0.0616870570492459, 0.192239265512194, 0.389429953333776, 0.641653425060474, 0.944597853652721, 1.29586962091933, 1.58302381801034, 1.80487399192662, 1.84601265552949, 1.80878964451341, 1.64493352245057, 1.45049618582695, 1.26566978943382, 1.11934362706156, 1.07082670269049, 1.11712108317344, 1.22705772723290, 1.51516292607050, 1.81778376597393, 2.22081903258372, 2.44010965116183, 2.68457179443071, 2.86499699562554, 3.17294239174878, 3.64642002273844, 4.16238928709426, 4.57659145972332, 4.76261017316802, 4.62772684793620, 4.24499829228963, 3.56279806467952, 2.64903634499104, 1.64642008007233, 0.743459622832136, -0.0862734426315485, -0.729885934360766, -1.32553211978379, -1.82975375514394, -2.26187294336344, -2.60521878353510, -2.69166558764497, -2.74585512735467, -2.58131491821398, -2.31546319218056, -2.07750294253581, -1.74080977796506, -1.50775999409640, -1.41094655782713, -1.47078094566135, -1.58214821307130, -1.70525004313246, -1.73463000463735, -1.75465769879555, -1.75076144279425, -1.81720052094792, -1.72793119906239, -1.57866438712533, -1.40824582078194, -1.22854998679261, -1.03995015643837, -0.700525014954498, -0.486612059389739, -0.315459723637888, -0.168169693708658, -0.0638339494714057, -0.0464419062922593, -0.0845930726697237, -0.433916136879505, -1.02393514279949, -1.69529587697098, -2.24187773474466, -2.53888368976720, -2.62626061103947, -2.38820483991652, -1.82531969503752, -1.11142149836049, -0.405735186932426]
    motor_kv = 115
    torque_const = 8.27 / motor_kv

    # A sine wave to test
    for torque in elbow_torque:
        try:
            driver_name.axis0.controller.input_torque = torque
            clear_errors(driver_name)

            output_pos, output_vel, output_current = get_motor_state(driver_name)
            # print("Moving to {} [turn]".format(output_pos))
            # print("Moving at {} [turn/s]".format(output_vel))
            print("Motor current is {} [A]".format(output_current))
            # print("The torque error is {} [N/m]".format(torque - output_current * torque_const))
            time.sleep(1/100)

        except:
            print("Couldn't complete motion. shutting down")
            shut_down(driver_name)
            raise


def main(args):
    # Find a connected ODrive
    print("Finding an ODrive...")
    odrv0 = odrive.find_any()

    if args["calibration"]:
        # Calibrate motor
        Calibration(odrv0)

    odrv0.axis0.requested_state = AXIS_STATE_CLOSED_LOOP_CONTROL
    odrv0.axis0.controller.config.input_mode = INPUT_MODE_PASSTHROUGH

    # To read a value, simply read the property
    print("The boards main supply voltage is {}V".format(str(odrv0.vbus_voltage)))

    # Moving to straight position
    odrv0.axis0.controller.config.control_mode = CONTROL_MODE_POSITION_CONTROL
    odrv0.axis0.controller.input_pos = STRAIGHT_POSITION
    print("Initializing position")

    # Plotting position, velocity and current graph
    liveplot(odrv0)

    # position_control(odrv0)
    # velocity_control(odrv0)
    current_control(odrv0)

    print("Finished motion. shutting down")
    shut_down(odrv0)


if __name__ == '__main__':
    # construct the argument parse and parse the arguments
    parser = argparse.ArgumentParser()
    parser.add_argument("-c", "--calibration", help="calibrate motor")
    args = vars(parser.parse_args())
    main(args)
